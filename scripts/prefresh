#!/bin/bash

set -e
terminus_version

PROJECTDIR="Sites"
if [[ "${PWD}" =~ ^${HOME}/Projects ]]; then
    PROJECTDIR="Projects"
fi

if [ -z "$1" ]
then
    if [[ ! "${PWD}" =~ ^${HOME}/$PROJECTDIR ]]; then
        echo "Not in a Project directory like ~/Sites or ~/Projects"
        exit 1;
    fi

    SITE=${PWD##*/$PROJECTDIR/}
    SITE=${SITE%%/*}
else
    SITE=$1
fi;

if [ -z "$2" ]
then
        ENV="dev"
else
        ENV=$2
fi;


if [ "$SITE" = "live" ] || [ "$SITE" = "dev" ] || [ "$SITE" = "test" ]
then
    ENV=$SITE
    ROOT=$(drush ev "print DRUPAL_ROOT");
    SITE=${ROOT##*/}
fi;

cd $HOME/Sites/$SITE
if [ "$TERMINUS_OLD" = true ]; then
    terminus site wake --site=$SITE --env=$ENV
else
    terminus env:wake "$SITE.$ENV"
fi
chmod 775 ~/Sites/$SITE/sites/default &&
git pull &&
terminus-ssp $SITE $ENV &&
drushfiles $SITE $ENV